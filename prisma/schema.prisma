generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  name           String?
  profileImage   String?
  authentikId    String    @unique
  isAdmin        Boolean   @default(false)
  isActive       Boolean   @default(true)
  templatePath   String?
  organizationId String?
  role           String    @default("member") // 'admin' | 'member'
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization        Organization? @relation(fields: [organizationId], references: [id])
  descriptionDocs     DescriptionDocument[] @relation("UserDocs")
  createdDocs         DescriptionDocument[] @relation("CreatedByDocs")
  conversionJobs      ConversionJob[]
  federalRegisterDocs FederalRegisterDocument[]
  selectedClientOutputs ClientOutput[] @relation("SelectedBy")

  @@index([organizationId])
}

model DescriptionDocument {
  id        String   @id @default(cuid())
  userId    String
  content   String
  version   Int      @default(1)
  isCurrent Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdById String?

  user      User     @relation("UserDocs", fields: [userId], references: [id], onDelete: Cascade)
  createdBy User?    @relation("CreatedByDocs", fields: [createdById], references: [id])
  jobs      ConversionJob[]

  @@index([userId, isCurrent])
}

model ConversionJob {
  id                    String    @id @default(cuid())
  userId                String
  status                String    @default("pending")
  inputFilename         String
  inputPath             String
  inputSizeBytes        BigInt?
  extractedText         String?
  descriptionDocId      String?
  processingStartedAt   DateTime?
  processingCompletedAt DateTime?
  outputFilename        String?
  outputPath            String?
  outputSizeBytes       BigInt?
  errorMessage          String?
  metadata              Json?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user           User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  descriptionDoc DescriptionDocument? @relation(fields: [descriptionDocId], references: [id])
  federalRegisterDoc FederalRegisterDocument?

  @@index([userId, status])
  @@index([status])
}

model FederalRegisterDocument {
  id               String    @id @default(cuid())
  documentNumber   String    @unique
  citation         String?
  title            String
  documentType     String?
  abstract         String?
  publicationDate  DateTime
  pdfUrl           String
  htmlUrl          String?
  isSignificant    Boolean   @default(false)
  agencies         Json?
  autoProcess      Boolean   @default(true)
  targetUserId     String?
  conversionJobId  String?   @unique
  detectedAt       DateTime  @default(now())
  pdfDownloadedAt  DateTime?
  processingStatus String    @default("pending")
  errorMessage     String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  targetUser    User?          @relation(fields: [targetUserId], references: [id])
  conversionJob ConversionJob? @relation(fields: [conversionJobId], references: [id])

  @@index([documentNumber])
  @@index([publicationDate(sort: Desc)])
  @@index([processingStatus])
  @@index([targetUserId])
}

model FederalRegisterSettings {
  id                     String    @id @default(cuid())
  isEnabled              Boolean   @default(true)
  pollIntervalMinutes    Int       @default(15)
  agencySlugs            String[]  @default(["centers-for-medicare-medicaid-services"])
  documentTypes          String[]  @default(["RULE", "PRORULE", "NOTICE"])
  onlySignificant        Boolean   @default(false)
  defaultTargetUserId    String?
  autoProcessNew         Boolean   @default(true)
  lastPollAt             DateTime?
  lastPollStatus         String?
  lastPollDocumentsFound Int?
  initialized            Boolean   @default(false)
  initialDocumentCount   Int       @default(5)
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
}

// ============================================
// Multi-Tenant Models
// ============================================

model Agency {
  id                   String   @id // 'cms', 'fda', etc.
  name                 String
  federalRegisterSlug  String
  newsroomFeeds        Json     @default("[]") // Array of {url, name, type, enabled}
  documentTypes        String[] @default(["RULE", "PRORULE", "NOTICE"])
  isActive             Boolean  @default(true)
  createdAt            DateTime @default(now())

  organizationAgencies OrganizationAgency[]
  regulatoryDocuments  RegulatoryDocument[]
}

model Organization {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  slug        String   @unique
  outputType  String   @default("pptx") // 'pptx' | 'memo_pdf'
  branding    Json     @default("{}")
  modelConfig Json     @default("{\"base_model\": \"claude-sonnet-4-5-20250929\", \"customization_model\": \"claude-haiku-4-5-20251001\"}")
  hasClients  Boolean  @default(false)
  autoProcess Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users                User[]
  clients              Client[]
  organizationAgencies OrganizationAgency[]
  documentOutputs      DocumentOutput[]
}

model OrganizationAgency {
  organizationId          String   @db.Uuid
  agencyId                String
  federalRegisterEnabled  Boolean  @default(true)
  newsroomEnabled         Boolean  @default(true)
  documentTypes           String[]

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  agency       Agency       @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  @@id([organizationId, agencyId])
}

model Client {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String   @db.Uuid
  name           String
  context        String   // Paragraph describing the client
  industry       String?
  focusAreas     String[]
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization  Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  clientOutputs ClientOutput[]

  @@index([organizationId])
}

model RegulatoryDocument {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  source          String    // 'federal_register' | 'newsroom_rss'
  agencyId        String
  externalId      String    // document_number for FR, guid for RSS
  title           String
  abstract        String?
  publicationDate DateTime? @db.Date
  sourceUrl       String?
  pdfUrl          String?
  citation        String?
  documentType    String?
  isSignificant   Boolean?
  feedName        String?
  detectedAt      DateTime  @default(now())
  contentHash     String?
  createdAt       DateTime  @default(now())

  agency          Agency           @relation(fields: [agencyId], references: [id])
  documentOutputs DocumentOutput[]

  @@unique([source, externalId])
  @@index([agencyId])
  @@index([publicationDate(sort: Desc)])
  @@index([detectedAt(sort: Desc)])
}

model DocumentOutput {
  id                     String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  regulatoryDocumentId   String    @db.Uuid
  organizationId         String    @db.Uuid
  outputType             String    // 'pptx' | 'memo_pdf'
  outputPath             String?
  status                 String    @default("pending") // pending, processing, complete, failed
  errorMessage           String?
  isBaseOutput           Boolean   @default(true)
  modelUsed              String?
  tokensInput            Int?
  tokensOutput           Int?
  processingStartedAt    DateTime?
  processingCompletedAt  DateTime?
  createdAt              DateTime  @default(now())

  regulatoryDocument RegulatoryDocument @relation(fields: [regulatoryDocumentId], references: [id])
  organization       Organization       @relation(fields: [organizationId], references: [id])
  clientOutputs      ClientOutput[]

  @@unique([regulatoryDocumentId, organizationId, isBaseOutput])
  @@index([organizationId])
  @@index([status])
}

model ClientOutput {
  id                     String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  documentOutputId       String    @db.Uuid
  clientId               String    @db.Uuid
  outputPath             String?
  status                 String    @default("pending") // pending, selected, processing, complete, failed, skipped
  errorMessage           String?
  selectedForGeneration  Boolean   @default(false)
  selectedBy             String?
  selectedAt             DateTime?
  modelUsed              String?
  tokensInput            Int?
  tokensOutput           Int?
  processingStartedAt    DateTime?
  processingCompletedAt  DateTime?
  createdAt              DateTime  @default(now())

  documentOutput DocumentOutput @relation(fields: [documentOutputId], references: [id], onDelete: Cascade)
  client         Client         @relation(fields: [clientId], references: [id], onDelete: Cascade)
  selectedByUser User?          @relation("SelectedBy", fields: [selectedBy], references: [id])

  @@unique([documentOutputId, clientId])
  @@index([status])
  @@index([clientId])
}
